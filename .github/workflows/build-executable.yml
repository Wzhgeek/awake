name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: awake-windows.exe
            executable_name: awake.exe
          - os: ubuntu-latest
            artifact_name: awake-linux
            executable_name: awake
          - os: macos-latest
            artifact_name: awake-macos
            executable_name: awake

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y portaudio19-dev python3-pyaudio libasound2-dev

    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install portaudio

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller awake.spec --distpath dist --workpath build --clean

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        move dist\awake.exe dist\awake-windows.exe

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        mv dist/awake dist/awake-linux

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶ (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        mv dist/awake dist/awake-macos

    - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
      run: |
        ls -la dist/

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      
    - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
      run: |
        ls -la
        find . -name "awake-*" -type f
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          awake-windows.exe/awake-windows.exe
          awake-linux/awake-linux
          awake-macos/awake-macos
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "ç¦»çº¿å”¤é†’è¯æ£€æµ‹ ${{ github.ref_name }}"
        body: |
          ## ğŸ¯ ç¦»çº¿å”¤é†’è¯æ£€æµ‹ç³»ç»Ÿ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `awake-windows.exe`
          - **Linuxç”¨æˆ·**: ä¸‹è½½ `awake-linux` (éœ€è¦æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x awake-linux`)
          - **macOSç”¨æˆ·**: ä¸‹è½½ `awake-macos` (éœ€è¦æ·»åŠ æ‰§è¡Œæƒé™: `chmod +x awake-macos`)
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œç¨‹åºï¼ˆWindowsï¼‰æˆ–åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼ˆLinux/macOSï¼‰
          3. å¯¹ç€éº¦å…‹é£è¯´å‡º"è¿ˆçµè¿ˆçµ"è¿›è¡Œå”¤é†’æµ‹è¯•
          4. ç¨‹åºä¼šè¾“å‡ºJSONæ ¼å¼çš„å”¤é†’çŠ¶æ€: `{"awake": true}`
          
          ### âš™ï¸ è¿è¡Œè¦æ±‚
          - éœ€è¦éº¦å…‹é£æƒé™
          - ç¡®ä¿éŸ³é¢‘è®¾å¤‡æ­£å¸¸å·¥ä½œ
          - å»ºè®®åœ¨å®‰é™ç¯å¢ƒä¸‹ä½¿ç”¨ä»¥æé«˜è¯†åˆ«å‡†ç¡®ç‡
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - ï¿½ï¿½ åŸºäºPorcupineå¼•æ“çš„ç¦»çº¿è¯­éŸ³è¯†åˆ«
          - ğŸ—£ï¸ æ”¯æŒä¸­æ–‡å”¤é†’è¯"è¿ˆçµè¿ˆçµ"
          - ğŸŒ æ— éœ€ç½‘ç»œè¿æ¥ï¼Œå®Œå…¨ç¦»çº¿è¿è¡Œ
          - ğŸ’» è·¨å¹³å°æ”¯æŒï¼šWindowsã€Linuxã€macOS
          - âš¡ ä½å»¶è¿Ÿï¼Œå®æ—¶å“åº”
          
          ### ğŸš¨ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦æˆäºˆéº¦å…‹é£è®¿é—®æƒé™
          - macOSç”¨æˆ·å¯èƒ½éœ€è¦åœ¨"å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
          - ä½¿ç”¨Ctrl+Cå¯ä»¥å®‰å…¨é€€å‡ºç¨‹åº
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 