name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: awake-windows.exe
            executable_name: awake.exe

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: ç¼“å­˜Pythonä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ${{ env.pythonLocation }}
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        pyinstaller awake.spec --distpath dist --workpath build --clean

    - name: é‡å‘½åå¯æ‰§è¡Œæ–‡ä»¶
      run: |
        move dist\awake.exe dist\awake-windows.exe

    - name: æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
      shell: cmd
      run: |
        dist\${{ matrix.artifact_name }} --version || dist\${{ matrix.artifact_name }} -v || echo "Executable test completed"

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: dist/${{ matrix.artifact_name }}
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: åˆ—å‡ºä¸‹è½½çš„æ–‡ä»¶
      run: |
        ls -la
        find . -name "awake-*" -type f
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          awake-windows.exe/awake-windows.exe
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "ç¦»çº¿å”¤é†’è¯æ£€æµ‹ ${{ github.ref_name }}"
        body: |
          ## ğŸ¯ ç¦»çº¿å”¤é†’è¯æ£€æµ‹ç³»ç»Ÿ ${{ github.ref_name }}
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **Windowsç”¨æˆ·**: ä¸‹è½½ `awake-windows.exe`
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯æ‰§è¡Œæ–‡ä»¶
          2. åŒå‡»è¿è¡Œç¨‹åº
          3. å¯¹ç€éº¦å…‹é£è¯´å‡º"è¿ˆçµè¿ˆçµ"è¿›è¡Œå”¤é†’æµ‹è¯•
          4. ç¨‹åºä¼šè¾“å‡ºJSONæ ¼å¼çš„å”¤é†’çŠ¶æ€: `{"awake": true}`
          
          ### âš™ï¸ è¿è¡Œè¦æ±‚
          - éœ€è¦éº¦å…‹é£æƒé™
          - ç¡®ä¿éŸ³é¢‘è®¾å¤‡æ­£å¸¸å·¥ä½œ
          - å»ºè®®åœ¨å®‰é™ç¯å¢ƒä¸‹ä½¿ç”¨ä»¥æé«˜è¯†åˆ«å‡†ç¡®ç‡
          
          ### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
          - âš™ï¸ åŸºäºPorcupineå¼•æ“çš„ç¦»çº¿è¯­éŸ³è¯†åˆ«
          - ğŸ—£ï¸ æ”¯æŒä¸­æ–‡å”¤é†’è¯"è¿ˆçµè¿ˆçµ"
          - ğŸŒ æ— éœ€ç½‘ç»œè¿æ¥ï¼Œå®Œå…¨ç¦»çº¿è¿è¡Œ
          - ğŸ’» æ”¯æŒWindowså¹³å°
          - âš¡ ä½å»¶è¿Ÿï¼Œå®æ—¶å“åº”
          
          ### ğŸš¨ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦æˆäºˆéº¦å…‹é£è®¿é—®æƒé™
          - ä½¿ç”¨Ctrl+Cå¯ä»¥å®‰å…¨é€€å‡ºç¨‹åº
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 